/**
    * @license
    * Copyright 2022 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@mediapipe/face_mesh"),require("@tensorflow/tfjs-core"),require("@tensorflow/tfjs-converter")):"function"==typeof define&&define.amd?define(["exports","@mediapipe/face_mesh","@tensorflow/tfjs-core","@tensorflow/tfjs-converter"],t):t((e=e||self).faceLandmarksDetection={},e.globalThis,e.tf,e.tf)}(this,(function(e,t,n,i){"use strict";var r=function(){return r=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},r.apply(this,arguments)};function o(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))}function a(e,t){var n,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function s(e){var t=e.map((function(e){return e[0]}));return t.push(e[e.length-1][1]),t}var u={lips:s(t.FACEMESH_LIPS),leftEye:s(t.FACEMESH_LEFT_EYE),leftEyebrow:s(t.FACEMESH_LEFT_EYEBROW),leftIris:s(t.FACEMESH_LEFT_IRIS),rightEye:s(t.FACEMESH_RIGHT_EYE),rightEyebrow:s(t.FACEMESH_RIGHT_EYEBROW),rightIris:s(t.FACEMESH_RIGHT_IRIS),faceOval:s(t.FACEMESH_FACE_OVAL)},h=t.FACEMESH_TESSELATION,c=Object.entries(u).map((function(e){var t=e[0];return e[1].map((function(e){return[e,t]}))})).flat(),l=new Map(c);function d(e){for(var t={locationData:{relativeKeypoints:[]}},n=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER,a=0;a<e.length;++a){var s=e[a];n=Math.min(n,s.x),i=Math.max(i,s.x),r=Math.min(r,s.y),o=Math.max(o,s.y),t.locationData.relativeKeypoints.push({x:s.x,y:s.y})}return t.locationData.relativeBoundingBox={xMin:n,yMin:r,xMax:i,yMax:o,width:i-n,height:o-r},t}var f={runtime:"mediapipe",maxFaces:1,refineLandmarks:!1};var p=function(){function e(e){var n=this;this.width=0,this.height=0,this.selfieMode=!1,this.faceMeshSolution=new t.FaceMesh({locateFile:function(t,n){return e.solutionPath?e.solutionPath.replace(/\/+$/,"")+"/"+t:n+"/"+t}}),this.faceMeshSolution.setOptions({refineLandmarks:e.refineLandmarks,selfieMode:this.selfieMode,maxNumFaces:e.maxFaces}),this.faceMeshSolution.onResults((function(e){if(n.height=e.image.height,n.width=e.image.width,n.faces=[],null!==e.multiFaceLandmarks)for(var t=e.multiFaceLandmarks,i=0;i<t.length;i++){var r=n.translateOutput(t[i]);n.faces.push({keypoints:r,box:d(r).locationData.relativeBoundingBox})}}))}return e.prototype.translateOutput=function(e){var t=this;return e.map((function(e,n){var i={x:e.x*t.width,y:e.y*t.height,z:e.z*t.width},r=l.get(n);return null!=r&&(i.name=r),i}))},e.prototype.estimateFaces=function(e,t){return o(this,void 0,void 0,(function(){var i,r;return a(this,(function(o){switch(o.label){case 0:return t&&t.flipHorizontal&&t.flipHorizontal!==this.selfieMode&&(this.selfieMode=t.flipHorizontal,this.faceMeshSolution.setOptions({selfieMode:this.selfieMode})),e instanceof n.Tensor?(r=ImageData.bind,[4,n.browser.toPixels(e)]):[3,2];case 1:return i=new(r.apply(ImageData,[void 0,o.sent(),e.shape[1],e.shape[0]])),[3,3];case 2:i=e,o.label=3;case 3:return e=i,[4,this.faceMeshSolution.send({image:e})];case 4:return o.sent(),[2,this.faces]}}))}))},e.prototype.dispose=function(){this.faceMeshSolution.close()},e.prototype.reset=function(){this.faceMeshSolution.reset(),this.width=0,this.height=0,this.faces=null,this.selfieMode=!1},e.prototype.initialize=function(){return this.faceMeshSolution.initialize()},e}();function m(e){return o(this,void 0,void 0,(function(){var t,n;return a(this,(function(i){switch(i.label){case 0:return t=function(e){if(null==e)return r({},f);var t=r({},e);return t.runtime="mediapipe",null==t.maxFaces&&(t.maxFaces=f.maxFaces),null==t.refineLandmarks&&(t.refineLandmarks=f.refineLandmarks),t}(e),[4,(n=new p(t)).initialize()];case 1:return i.sent(),[2,n]}}))}))}function g(e){return e.width*e.height}function x(e){var t=e.xCenter-e.width/2,n=t+e.width,i=e.yCenter-e.height/2;return{xMin:t,xMax:n,yMin:i,yMax:i+e.height,width:e.width,height:e.height}}function y(e,t){var n=x(e),i=x(t);if(!function(e,t){return!(e.xMax<t.xMin||t.xMax<e.xMin||e.yMax<t.yMin||t.yMax<e.yMin)}(n,i))return 0;var r=g(function(e,t){var n=Math.max(e.xMin,t.xMin),i=Math.min(e.xMax,t.xMax),r=Math.max(e.yMin,t.yMin),o=Math.min(e.yMax,t.yMax);return{xMin:n,xMax:i,yMin:r,yMax:o,width:Math.max(i-n,0),height:Math.max(o-r,0)}}(n,i)),o=g(n)+g(i)-r;return o>0?r/o:0}function M(e,t,n,i){var r=e.width,o=e.height,a=i?-1:1,s=Math.cos(e.rotation),u=Math.sin(e.rotation),h=e.xCenter,c=e.yCenter,l=1/t,d=1/n,f=new Array(16);return f[0]=r*s*a*l,f[1]=-o*u*l,f[2]=0,f[3]=(-.5*r*s*a+.5*o*u+h)*l,f[4]=r*u*a*d,f[5]=o*s*d,f[6]=0,f[7]=(-.5*o*s-.5*r*u*a+c)*d,f[8]=0,f[9]=0,f[10]=r*l,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,function(e){if(16!==e.length)throw new Error("Array length must be 16 but got "+e.length);return[[e[0],e[1],e[2],e[3]],[e[4],e[5],e[6],e[7]],[e[8],e[9],e[10],e[11]],[e[12],e[13],e[14],e[15]]]}(f)}function v(e){return e instanceof n.Tensor?{height:e.shape[0],width:e.shape[1]}:{height:e.height,width:e.width}}function w(e){return e-2*Math.PI*Math.floor((e+Math.PI)/(2*Math.PI))}function b(e){return e instanceof n.Tensor?e:n.browser.fromPixels(e)}function S(e,t){n.util.assert(0!==e.width,(function(){return t+" width cannot be 0."})),n.util.assert(0!==e.height,(function(){return t+" height cannot be 0."}))}function E(e,t){var i=function(e,t,n,i){var r=t-e,o=i-n;if(0===r)throw new Error("Original min and max are both "+e+", range cannot be 0.");var a=o/r;return{scale:a,offset:n-e*a}}(0,255,t[0],t[1]);return n.tidy((function(){return n.add(n.mul(e,i.scale),i.offset)}))}function z(e,t,i){var r=t.outputTensorSize,o=t.keepAspectRatio,a=t.borderMode,s=t.outputTensorFloatRange,u=v(e),h=function(e,t){return t?{xCenter:t.xCenter*e.width,yCenter:t.yCenter*e.height,width:t.width*e.width,height:t.height*e.height,rotation:t.rotation}:{xCenter:.5*e.width,yCenter:.5*e.height,width:e.width,height:e.height,rotation:0}}(u,i),c=function(e,t,n){if(void 0===n&&(n=!1),!n)return{top:0,left:0,right:0,bottom:0};var i=t.height,r=t.width;S(t,"targetSize"),S(e,"roi");var o,a,s=i/r,u=e.height/e.width,h=0,c=0;return s>u?(o=e.width,a=e.width*s,c=(1-u/s)/2):(o=e.height/s,a=e.height,h=(1-s/u)/2),e.width=o,e.height=a,{top:c,left:h,right:h,bottom:c}}(h,r,o),l=M(h,u.width,u.height,!1),d=n.tidy((function(){var t=b(e),i=n.tensor2d(function(e,t,n){return S(n,"inputResolution"),[1/n.width*e[0][0]*t.width,1/n.height*e[0][1]*t.width,e[0][3]*t.width,1/n.width*e[1][0]*t.height,1/n.height*e[1][1]*t.height,e[1][3]*t.height,0,0]}(l,u,r),[1,8]),o="zero"===a?"constant":"nearest",h=n.image.transform(n.expandDims(n.cast(t,"float32")),i,"bilinear",o,0,[r.height,r.width]);return null!=s?E(h,s):h}));return{imageTensor:d,padding:c,transformationMatrix:l}}function C(e){null==e.reduceBoxesInLowestLayer&&(e.reduceBoxesInLowestLayer=!1),null==e.interpolatedScaleAspectRatio&&(e.interpolatedScaleAspectRatio=1),null==e.fixedAnchorSize&&(e.fixedAnchorSize=!1);for(var t=[],n=0;n<e.numLayers;){for(var i=[],r=[],o=[],a=[],s=n;s<e.strides.length&&e.strides[s]===e.strides[n];){var u=T(e.minScale,e.maxScale,s,e.strides.length);if(0===s&&e.reduceBoxesInLowestLayer)o.push(1),o.push(2),o.push(.5),a.push(.1),a.push(u),a.push(u);else{for(var h=0;h<e.aspectRatios.length;++h)o.push(e.aspectRatios[h]),a.push(u);if(e.interpolatedScaleAspectRatio>0){var c=s===e.strides.length-1?1:T(e.minScale,e.maxScale,s+1,e.strides.length);a.push(Math.sqrt(u*c)),o.push(e.interpolatedScaleAspectRatio)}}s++}for(var l=0;l<o.length;++l){var d=Math.sqrt(o[l]);i.push(a[l]/d),r.push(a[l]*d)}var f=0,p=0;if(e.featureMapHeight.length>0)f=e.featureMapHeight[n],p=e.featureMapWidth[n];else{var m=e.strides[n];f=Math.ceil(e.inputSizeHeight/m),p=Math.ceil(e.inputSizeWidth/m)}for(var g=0;g<f;++g)for(var x=0;x<p;++x)for(var y=0;y<i.length;++y){var M={xCenter:(x+e.anchorOffsetX)/p,yCenter:(g+e.anchorOffsetY)/f,width:0,height:0};e.fixedAnchorSize?(M.width=1,M.height=1):(M.width=r[y],M.height=i[y]),t.push(M)}n=s}return t}function T(e,t,n,i){return 1===i?.5*(e+t):e+(t-e)*n/(i-1)}function F(e,t){var n=t[0],i=t[1];return[n*e[0]+i*e[1]+e[3],n*e[4]+i*e[5]+e[7]]}function A(e){return{xCenter:e.xMin+e.width/2,yCenter:e.yMin+e.height/2,width:e.width,height:e.height}}function I(e){var t=e.relativeKeypoints;if(t.length<=1)throw new Error("2 or more keypoints required to calculate a rect.");var n=Number.MAX_VALUE,i=Number.MAX_VALUE,r=Number.MIN_VALUE,o=Number.MIN_VALUE;return t.forEach((function(e){n=Math.min(n,e.x),r=Math.max(r,e.x),i=Math.min(i,e.y),o=Math.max(o,e.y)})),{xCenter:(n+r)/2,yCenter:(i+o)/2,width:r-n,height:o-i}}function L(e,t,n,i,r){var o="rect"===n?function(e,t,n){var i,r=e.locationData;if("boundingbox"===t)i=A(r.boundingBox);else{i=I(r);var o=n.width,a=n.height;i.xCenter=Math.round(i.xCenter*o),i.yCenter=Math.round(i.yCenter*a),i.width=Math.round(i.width*o),i.height=Math.round(i.height*a)}return i}(e,t,i):function(e,t){var n=e.locationData;return"boundingbox"===t?A(n.relativeBoundingBox):I(n)}(e,t);return r&&(o.rotation=function(e,t,n){var i,r=e.locationData,o=n.rotationVectorStartKeypointIndex,a=n.rotationVectorEndKeypointIndex;i=n.rotationVectorTargetAngle?n.rotationVectorTargetAngle:Math.PI*n.rotationVectorTargetAngleDegree/180;var s=r.relativeKeypoints[o].x*t.width,u=r.relativeKeypoints[o].y*t.height,h=r.relativeKeypoints[a].x*t.width,c=r.relativeKeypoints[a].y*t.height;return w(i-Math.atan2(-(c-u),h-s))}(e,i,r)),o}function k(e){return n.tidy((function(){var t=function(e){return n.tidy((function(){return[n.slice(e,[0,0,0],[1,-1,1]),n.slice(e,[0,0,1],[1,-1,-1])]}))}(e),i=t[0],r=t[1];return{boxes:n.squeeze(r),logits:n.squeeze(i)}}))}function _(e,t,n){for(var i=0;i<t.length;++i){var r=t[i],o={x:r.x,y:r.y};n[e[i]]=o}}function R(e,t,n,i){if("string"==typeof t){if("copy"===t)for(var r=0;r<n.length;++r)i[e[r]].z=n[r].z}else{var o=function(e,t){for(var n=0,i=0;i<t.length;++i)n+=e[t[i]].z;return n/t.length}(i,t);for(r=0;r<e.length;++r)i[e[r]].z=o}}function O(e,t){for(var n=function(e){var t=[].concat.apply([],e.map((function(e){return e.indexesMapping})));if(0===t.length)throw new Error("There should be at least one landmark in indexes mapping");var n=t[0],i=t[0],r=new Set(t);r.forEach((function(e){n=Math.min(n,e),i=Math.max(i,e)}));var o=r.size;if(0!==n)throw new Error("Indexes are expected to start with 0 instead of "+n);if(i+1!==o)throw new Error("Indexes should have no gaps but "+(i-o+1)+" indexes are missing");return o}(t),i=new Array(n),r=0;r<e.length;++r){var o=e[r],a=t[r];if(o.length!==a.indexesMapping.length)throw new Error("There are "+o.length+" refinement landmarks while mapping has "+a.indexesMapping.length);_(a.indexesMapping,o,i),R(a.indexesMapping,a.zRefinement,o,i)}return i}function B(e,t,i,r){return o(this,void 0,void 0,(function(){var r,o,s,u,h;return a(this,(function(a){switch(a.label){case 0:return e.sort((function(e,t){return Math.max.apply(Math,t.score)-Math.max.apply(Math,e.score)})),r=n.tensor2d(e.map((function(e){return[e.locationData.relativeBoundingBox.yMin,e.locationData.relativeBoundingBox.xMin,e.locationData.relativeBoundingBox.yMax,e.locationData.relativeBoundingBox.xMax]}))),o=n.tensor1d(e.map((function(e){return e.score[0]}))),[4,n.image.nonMaxSuppressionAsync(r,o,t,i)];case 1:return[4,(s=a.sent()).array()];case 2:return u=a.sent(),h=e.filter((function(e,t){return u.indexOf(t)>-1})),n.dispose([r,o,s]),[2,h]}}))}))}function H(e,t){return e.map((function(e){var n=r(r({},e),{x:e.x*t.width,y:e.y*t.height});return null!=e.z&&(n.z=e.z*t.width),n}))}function D(e,t,i){return o(this,void 0,void 0,(function(){var r,o,s,u,h;return a(this,(function(a){switch(a.label){case 0:return r=e[0],o=e[1],s=function(e,t,i){return n.tidy((function(){var r,o,a,s;i.reverseOutputOrder?(o=n.squeeze(n.slice(e,[0,i.boxCoordOffset+0],[-1,1])),r=n.squeeze(n.slice(e,[0,i.boxCoordOffset+1],[-1,1])),s=n.squeeze(n.slice(e,[0,i.boxCoordOffset+2],[-1,1])),a=n.squeeze(n.slice(e,[0,i.boxCoordOffset+3],[-1,1]))):(r=n.squeeze(n.slice(e,[0,i.boxCoordOffset+0],[-1,1])),o=n.squeeze(n.slice(e,[0,i.boxCoordOffset+1],[-1,1])),a=n.squeeze(n.slice(e,[0,i.boxCoordOffset+2],[-1,1])),s=n.squeeze(n.slice(e,[0,i.boxCoordOffset+3],[-1,1]))),o=n.add(n.mul(n.div(o,i.xScale),t.w),t.x),r=n.add(n.mul(n.div(r,i.yScale),t.h),t.y),i.applyExponentialOnBoxSize?(a=n.mul(n.exp(n.div(a,i.hScale)),t.h),s=n.mul(n.exp(n.div(s,i.wScale)),t.w)):(a=n.mul(n.div(a,i.hScale),t.h),s=n.mul(n.div(s,i.wScale),t.h));var u=n.sub(r,n.div(a,2)),h=n.sub(o,n.div(s,2)),c=n.add(r,n.div(a,2)),l=n.add(o,n.div(s,2)),d=n.concat([n.reshape(u,[i.numBoxes,1]),n.reshape(h,[i.numBoxes,1]),n.reshape(c,[i.numBoxes,1]),n.reshape(l,[i.numBoxes,1])],1);if(i.numKeypoints)for(var f=0;f<i.numKeypoints;++f){var p=i.keypointCoordOffset+f*i.numValuesPerKeypoint,m=void 0,g=void 0;i.reverseOutputOrder?(m=n.squeeze(n.slice(e,[0,p],[-1,1])),g=n.squeeze(n.slice(e,[0,p+1],[-1,1]))):(g=n.squeeze(n.slice(e,[0,p],[-1,1])),m=n.squeeze(n.slice(e,[0,p+1],[-1,1])));var x=n.add(n.mul(n.div(m,i.xScale),t.w),t.x),y=n.add(n.mul(n.div(g,i.yScale),t.h),t.y);d=n.concat([d,n.reshape(x,[i.numBoxes,1]),n.reshape(y,[i.numBoxes,1])],1)}return d}))}(o,t,i),u=n.tidy((function(){var e=r;return i.sigmoidScore?(null!=i.scoreClippingThresh&&(e=n.clipByValue(r,-i.scoreClippingThresh,i.scoreClippingThresh)),e=n.sigmoid(e)):e})),[4,V(s,u,i)];case 1:return h=a.sent(),n.dispose([s,u]),[2,h]}}))}))}function V(e,t,n){return o(this,void 0,void 0,(function(){var i,r,o,s,u,h,c,l,d,f,p,m;return a(this,(function(a){switch(a.label){case 0:return i=[],[4,e.data()];case 1:return r=a.sent(),[4,t.data()];case 2:for(o=a.sent(),s=0;s<n.numBoxes;++s)if(!(null!=n.minScoreThresh&&o[s]<n.minScoreThresh||(u=s*n.numCoords,h=K(r[u+0],r[u+1],r[u+2],r[u+3],o[s],n.flipVertically,s),(c=h.locationData.relativeBoundingBox).width<0||c.height<0))){if(n.numKeypoints>0)for((l=h.locationData).relativeKeypoints=[],d=n.numKeypoints*n.numValuesPerKeypoint,f=0;f<d;f+=n.numValuesPerKeypoint)p=u+n.keypointCoordOffset+f,m={x:r[p+0],y:n.flipVertically?1-r[p+1]:r[p+1]},l.relativeKeypoints.push(m);i.push(h)}return[2,i]}}))}))}function K(e,t,n,i,r,o,a){return{score:[r],ind:a,locationData:{relativeBoundingBox:{xMin:t,yMin:o?1-n:e,xMax:i,yMax:o?1-e:n,width:i-t,height:n-e}}}}function U(e,t){return"none"===e?t:function(e){return 1/(1+Math.exp(-e))}(t)}function q(e,t,n,i){return o(this,void 0,void 0,(function(){var r,o,s,u,h,c,l,d;return a(this,(function(a){switch(a.label){case 0:return n=n||t.flipHorizontally||!1,i=i||t.flipVertically||!1,r=e.size,o=r/t.numLandmarks,[4,e.data()];case 1:for(s=a.sent(),u=[],h=0;h<t.numLandmarks;++h)c=h*o,(d={x:0,y:0}).x=n?t.inputImageWidth-s[c]:s[c],o>1&&(d.y=i?t.inputImageHeight-s[c+1]:s[c+1]),o>2&&(d.z=s[c+2]),o>3&&(d.score=U(t.visibilityActivation,s[c+3])),u.push(d);for(l=0;l<u.length;++l)(d=u[l]).x=d.x/t.inputImageWidth,d.y=d.y/t.inputImageHeight,d.z=d.z/t.inputImageWidth/(t.normalizeZ||1);return[2,u]}}))}))}function P(e,t,n){var i=e.width,r=e.height,o=e.rotation;if(null==n.rotation&&null==n.rotationDegree||(o=function(e,t){null!=t.rotation?e+=t.rotation:null!=t.rotationDegree&&(e+=Math.PI*t.rotationDegree/180);return w(e)}(o,n)),0===o)e.xCenter=e.xCenter+i*n.shiftX,e.yCenter=e.yCenter+r*n.shiftY;else{var a=(t.width*i*n.shiftX*Math.cos(o)-t.height*r*n.shiftY*Math.sin(o))/t.width,s=(t.width*i*n.shiftX*Math.sin(o)+t.height*r*n.shiftY*Math.cos(o))/t.height;e.xCenter=e.xCenter+a,e.yCenter=e.yCenter+s}if(n.squareLong){var u=Math.max(i*t.width,r*t.height);i=u/t.width,r=u/t.height}else if(n.squareShort){var h=Math.min(i*t.width,r*t.height);i=h/t.width,r=h/t.height}return e.width=i*n.scaleX,e.height=r*n.scaleY,e}var N="https://storage.googleapis.com/tfjs-testing/face-detection/face_detection_short_range/model.json",j="https://storage.googleapis.com/tfjs-testing/face-detection/face_landmark/model.json",W={reduceBoxesInLowestLayer:!1,interpolatedScaleAspectRatio:1,featureMapHeight:[],featureMapWidth:[],numLayers:4,minScale:.1484375,maxScale:.75,inputSizeHeight:128,inputSizeWidth:128,anchorOffsetX:.5,anchorOffsetY:.5,strides:[8,16,16,16],aspectRatios:[1],fixedAnchorSize:!0},X={reduceBoxesInLowestLayer:!1,interpolatedScaleAspectRatio:0,featureMapHeight:[],featureMapWidth:[],numLayers:1,minScale:.1484375,maxScale:.75,inputSizeHeight:192,inputSizeWidth:192,anchorOffsetX:.5,anchorOffsetY:.5,strides:[4],aspectRatios:[1],fixedAnchorSize:!0},Y={modelType:"short",maxFaces:1,detectorModelUrl:N},G={runtime:"tfjs",maxFaces:1,refineLandmarks:!1,detectorModelUrl:N,landmarkModelUrl:j},Z={flipHorizontal:!1,staticImageMode:!1},$={applyExponentialOnBoxSize:!1,flipVertically:!1,ignoreClasses:[],numClasses:1,numBoxes:896,numCoords:16,boxCoordOffset:0,keypointCoordOffset:4,numKeypoints:6,numValuesPerKeypoint:2,sigmoidScore:!0,scoreClippingThresh:100,reverseOutputOrder:!0,xScale:128,yScale:128,hScale:128,wScale:128,minScoreThresh:.5},J={applyExponentialOnBoxSize:!1,flipVertically:!1,ignoreClasses:[],numClasses:1,numBoxes:2304,numCoords:16,boxCoordOffset:0,keypointCoordOffset:4,numKeypoints:6,numValuesPerKeypoint:2,sigmoidScore:!0,scoreClippingThresh:100,reverseOutputOrder:!0,xScale:192,yScale:192,hScale:192,wScale:192,minScoreThresh:.6},Q=.3,ee={shiftX:0,shiftY:0,scaleX:1.5,scaleY:1.5,squareLong:!0},te={outputTensorSize:{width:128,height:128},keepAspectRatio:!0,outputTensorFloatRange:[-1,1],borderMode:"zero"},ne={outputTensorSize:{width:192,height:192},keepAspectRatio:!0,outputTensorFloatRange:[-1,1],borderMode:"zero"},ie={outputTensorSize:{width:192,height:192},outputTensorFloatRange:[0,1],borderMode:"replicate"},re={numLandmarks:468,inputImageWidth:192,inputImageHeight:192,visibilityActivation:"none",flipHorizontally:!1,flipVertically:!1},oe={numLandmarks:80,inputImageWidth:192,inputImageHeight:192,visibilityActivation:"none",flipHorizontally:!1,flipVertically:!1},ae={numLandmarks:71,inputImageWidth:192,inputImageHeight:192,visibilityActivation:"none",flipHorizontally:!1,flipVertically:!1},se={numLandmarks:5,inputImageWidth:192,inputImageHeight:192,visibilityActivation:"none",flipHorizontally:!1,flipVertically:!1},ue={indexesMapping:Array.from(Array(468).keys()),zRefinement:"copy"},he={indexesMapping:[61,146,91,181,84,17,314,405,321,375,291,185,40,39,37,0,267,269,270,409,78,95,88,178,87,14,317,402,318,324,308,191,80,81,82,13,312,311,310,415,76,77,90,180,85,16,315,404,320,307,306,184,74,73,72,11,302,303,304,408,62,96,89,179,86,15,316,403,319,325,292,183,42,41,38,12,268,271,272,407],zRefinement:"none"},ce={indexesMapping:[33,7,163,144,145,153,154,155,133,246,161,160,159,158,157,173,130,25,110,24,23,22,26,112,243,247,30,29,27,28,56,190,226,31,228,229,230,231,232,233,244,113,225,224,223,222,221,189,35,124,46,53,52,65,143,111,117,118,119,120,121,128,245,156,70,63,105,66,107,55,193],zRefinement:"none"},le={indexesMapping:[263,249,390,373,374,380,381,382,362,466,388,387,386,385,384,398,359,255,339,254,253,252,256,341,463,467,260,259,257,258,286,414,446,261,448,449,450,451,452,453,464,342,445,444,443,442,441,413,265,353,276,283,282,295,372,340,346,347,348,349,350,357,465,383,300,293,334,296,336,285,417],zRefinement:"none"},de={indexesMapping:[468,469,470,471,472],zRefinement:[33,7,163,144,145,153,154,155,133,246,161,160,159,158,157,173]},fe={indexesMapping:[473,474,475,476,477],zRefinement:[263,249,390,373,374,380,381,382,362,466,388,387,386,385,384,398]};var pe=function(){function e(e,t,i){this.detectorModel=t,this.maxFaces=i,"full"===e?(this.imageToTensorConfig=ne,this.tensorsToDetectionConfig=J,this.anchors=C(X)):(this.imageToTensorConfig=te,this.tensorsToDetectionConfig=$,this.anchors=C(W));var r=n.tensor1d(this.anchors.map((function(e){return e.width}))),o=n.tensor1d(this.anchors.map((function(e){return e.height}))),a=n.tensor1d(this.anchors.map((function(e){return e.xCenter}))),s=n.tensor1d(this.anchors.map((function(e){return e.yCenter})));this.anchorTensor={x:a,y:s,w:r,h:o}}return e.prototype.dispose=function(){this.detectorModel.dispose(),n.dispose([this.anchorTensor.x,this.anchorTensor.y,this.anchorTensor.w,this.anchorTensor.h])},e.prototype.reset=function(){},e.prototype.detectFaces=function(e,t){return void 0===t&&(t=!1),o(this,void 0,void 0,(function(){var i,r,o,s,u,h,c,l,d,f,p;return a(this,(function(a){switch(a.label){case 0:return null==e?(this.reset(),[2,[]]):(i=n.tidy((function(){var i=n.cast(b(e),"float32");if(t){i=n.squeeze(n.image.flipLeftRight(n.expandDims(i,0)),[0])}return i})),r=z(i,this.imageToTensorConfig),o=r.imageTensor,s=r.transformationMatrix,u=this.detectorModel.execute(o,"Identity:0"),h=k(u),c=h.boxes,[4,D([l=h.logits,c],this.anchorTensor,this.tensorsToDetectionConfig)]);case 1:return 0===(d=a.sent()).length?(n.dispose([i,o,u,l,c]),[2,d]):[4,B(d,this.maxFaces,Q)];case 2:return f=a.sent(),p=function(e,t){void 0===e&&(e=[]);var n,i=(n=t,[].concat.apply([],n));return e.forEach((function(e){var t=e.locationData;t.relativeKeypoints.forEach((function(e){var t=F(i,[e.x,e.y]),n=t[0],r=t[1];e.x=n,e.y=r}));var n=t.relativeBoundingBox,r=Number.MAX_VALUE,o=Number.MAX_VALUE,a=Number.MIN_VALUE,s=Number.MIN_VALUE;[[n.xMin,n.yMin],[n.xMin+n.width,n.yMin],[n.xMin+n.width,n.yMin+n.height],[n.xMin,n.yMin+n.height]].forEach((function(e){var t=F(i,e),n=t[0],u=t[1];r=Math.min(r,n),a=Math.max(a,n),o=Math.min(o,u),s=Math.max(s,u)})),t.relativeBoundingBox={xMin:r,xMax:a,yMin:o,yMax:s,width:a-r,height:s-o}})),e}(f,s),n.dispose([i,o,u,l,c]),[2,p]}}))}))},e}();function me(e){return o(this,void 0,void 0,(function(){var t,n,o;return a(this,(function(a){switch(a.label){case 0:return t=function(e){if(null==e)return r({},Y);var t=r({},e);null==t.modelType&&(t.modelType=Y.modelType),null==t.maxFaces&&(t.maxFaces=Y.maxFaces),null==t.detectorModelUrl&&("full"===t.modelType?t.detectorModelUrl="https://storage.googleapis.com/tfjs-testing/face-detection/face_detection_full_range_sparse/model.json":t.detectorModelUrl=N);return t}(e),n="string"==typeof t.detectorModelUrl&&t.detectorModelUrl.indexOf("https://tfhub.dev")>-1,[4,i.loadGraphModel(t.detectorModelUrl,{fromTFHub:n})];case 1:return o=a.sent(),[2,new pe(t.modelType,o,t.maxFaces)]}}))}))}var ge=function(){function e(e,t,n,i){this.detector=e,this.landmarkModel=t,this.maxFaces=n,this.withAttention=i,this.prevFaceRectsFromLandmarks=null}return e.prototype.estimateFaces=function(e,t){return o(this,void 0,void 0,(function(){var i,o,s,u,h,c,f,p,m,g,x,M,w,S=this;return a(this,(function(a){switch(a.label){case 0:return i=function(e){if(null==e)return r({},Z);var t=r({},e);return null==t.flipHorizontal&&(t.flipHorizontal=Z.flipHorizontal),null==t.staticImageMode&&(t.staticImageMode=Z.staticImageMode),t}(t),null==e?(this.reset(),[2,[]]):(o=v(e),s=n.tidy((function(){var t=n.cast(b(e),"float32");if(i.flipHorizontal){t=n.squeeze(n.image.flipLeftRight(n.expandDims(t,0)),[0])}return t})),u=this.prevFaceRectsFromLandmarks,i.staticImageMode||null==u||u.length<this.maxFaces?[4,this.detector.detectFaces(s)]:[3,2]);case 1:return 0===(c=a.sent()).length?(this.reset(),s.dispose(),[2,[]]):(h=c.map((function(e){return S.faceDetectionFrontDetectionToRoi(e,o)})),[3,3]);case 2:h=[],a.label=3;case 3:return E=.5,z=[],[h,u||[]].forEach((function(e){return e.forEach((function(e){(z=z.filter((function(t){return y(e,t)<=E}))).push(e)}))})),f=z,[4,Promise.all(f.map((function(e){return S.faceLandmark(e,s)})))];case 4:for(p=a.sent(),m=[],this.prevFaceRectsFromLandmarks=[],g=0;g<p.length;++g)null!=(x=p[g])&&(this.prevFaceRectsFromLandmarks.push(this.faceLandmarksToRoi(x,o)),null!=(M=H(x,o))&&M.forEach((function(e,t){var n=l.get(t);null!=n&&(e.name=n)})),w=d(M),m.push({keypoints:M,box:w.locationData.relativeBoundingBox}));return s.dispose(),[2,m]}var E,z}))}))},e.prototype.dispose=function(){this.detector.dispose(),this.landmarkModel.dispose()},e.prototype.reset=function(){this.detector.reset(),this.prevFaceRectsFromLandmarks=null},e.prototype.faceDetectionFrontDetectionToRoi=function(e,t){return P(L(e,"boundingbox","normRect",t,{rotationVectorStartKeypointIndex:0,rotationVectorEndKeypointIndex:1,rotationVectorTargetAngleDegree:0}),t,ee)},e.prototype.faceLandmark=function(e,t){return o(this,void 0,void 0,(function(){var i,o,s,u,h,c,l;return a(this,(function(a){switch(a.label){case 0:return i=z(t,ie,e).imageTensor,o=["output_faceflag"].concat(this.withAttention?["output_mesh_identity","output_lips","Identity_6:0","Identity_1:0","Identity_2:0","Identity_5:0"]:["output_mesh"]),s=this.landmarkModel.execute(i,o),u=s[0],h=s.slice(1),[4,u.data()];case 1:return a.sent()[0]<.5?(n.dispose(s),n.dispose(i),[2,null]):this.withAttention?[4,this.tensorsToFaceLandmarksWithAttention(h)]:[3,3];case 2:return c=a.sent(),[3,5];case 3:return[4,this.tensorsToFaceLandmarks(h)];case 4:c=a.sent(),a.label=5;case 5:return l=function(e,t,n){void 0===n&&(n={ignoreRotation:!1});for(var i=[],o=0,a=e;o<a.length;o++){var s=a[o],u=s.x-.5,h=s.y-.5,c=n.ignoreRotation?0:t.rotation,l=Math.cos(c)*u-Math.sin(c)*h,d=Math.sin(c)*u+Math.cos(c)*h;l=l*t.width+t.xCenter,d=d*t.height+t.yCenter;var f=s.z*t.width,p=r({},s);p.x=l,p.y=d,p.z=f,i.push(p)}return i}(c,e),n.dispose(s),n.dispose(i),[2,l]}}))}))},e.prototype.tensorsToFaceLandmarks=function(e){return o(this,void 0,void 0,(function(){return a(this,(function(t){return[2,q(e[0],re)]}))}))},e.prototype.tensorsToFaceLandmarksWithAttention=function(e){return o(this,void 0,void 0,(function(){var t,n,i,r,o,s;return a(this,(function(a){switch(a.label){case 0:return[4,q(e[0],re)];case 1:return t=a.sent(),[4,q(e[1],oe)];case 2:return n=a.sent(),[4,q(e[3],ae)];case 3:return i=a.sent(),[4,q(e[5],ae)];case 4:return r=a.sent(),[4,q(e[4],se)];case 5:return o=a.sent(),[4,q(e[2],se)];case 6:return s=a.sent(),[2,O([t,n,i,r,o,s],[ue,he,ce,le,de,fe])]}}))}))},e.prototype.faceLandmarksToRoi=function(e,t){return P(L(d(e),"boundingbox","normRect",t,{rotationVectorStartKeypointIndex:33,rotationVectorEndKeypointIndex:263,rotationVectorTargetAngleDegree:0}),t,ee)},e}();function xe(e){return o(this,void 0,void 0,(function(){var t,n,o,s;return a(this,(function(a){switch(a.label){case 0:return t=function(e){if(null==e)return r({},G);var t=r({},e);return t.runtime="tfjs",null==t.maxFaces&&(t.maxFaces=G.maxFaces),null==t.refineLandmarks&&(t.refineLandmarks=G.refineLandmarks),null==t.detectorModelUrl&&(t.detectorModelUrl=N),null==t.landmarkModelUrl&&(t.landmarkModelUrl=t.refineLandmarks?"https://storage.googleapis.com/tfjs-testing/face-detection/face_landmark_with_attention/model.json":j),t}(e),n="string"==typeof t.landmarkModelUrl&&t.landmarkModelUrl.indexOf("https://tfhub.dev")>-1,[4,i.loadGraphModel(t.landmarkModelUrl,{fromTFHub:n})];case 1:return o=a.sent(),[4,me({modelType:"short",maxFaces:t.maxFaces,detectorModelUrl:t.detectorModelUrl})];case 2:return s=a.sent(),[2,new ge(s,o,t.maxFaces,t.refineLandmarks)]}}))}))}(e.SupportedModels||(e.SupportedModels={})).MediaPipeFaceMesh="MediaPipeFaceMesh";var ye=Object.freeze({__proto__:null,getKeypointIndexByContour:function(t){if(t===e.SupportedModels.MediaPipeFaceMesh)return u;throw new Error("Model "+t+" is not supported.")},getAdjacentPairs:function(t){if(t===e.SupportedModels.MediaPipeFaceMesh)return h;throw new Error("Model "+t+" is not supported.")}});e.createDetector=function(t,n){return o(this,void 0,void 0,(function(){var i,r;return a(this,(function(o){if(t===e.SupportedModels.MediaPipeFaceMesh){if(r=void 0,null!=(i=n)){if("tfjs"===i.runtime)return[2,xe(i)];if("mediapipe"===i.runtime)return[2,m(i)];r=i.runtime}throw new Error("Expect modelConfig.runtime to be either 'tfjs' or 'mediapipe', but got "+r)}throw new Error(t+" is not a supported model name.")}))}))},e.util=ye,Object.defineProperty(e,"__esModule",{value:!0})}));
