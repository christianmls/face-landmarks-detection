/**
    * @license
    * Copyright 2022 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */
import{FACEMESH_LIPS as t,FACEMESH_LEFT_EYE as e,FACEMESH_LEFT_EYEBROW as n,FACEMESH_LEFT_IRIS as i,FACEMESH_RIGHT_EYE as r,FACEMESH_RIGHT_EYEBROW as o,FACEMESH_RIGHT_IRIS as a,FACEMESH_FACE_OVAL as s,FACEMESH_TESSELATION as h,FaceMesh as u}from"@mediapipe/face_mesh";import{Tensor as c,browser as l,util as f,tidy as d,add as p,mul as m,tensor2d as g,image as x,expandDims as y,cast as M,slice as v,squeeze as w,dispose as b,tensor1d as S,div as C,exp as T,sub as z,concat as k,reshape as F,clipByValue as L,sigmoid as I}from"@tensorflow/tfjs-core";import{loadGraphModel as A}from"@tensorflow/tfjs-converter";var E=function(){return E=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},E.apply(this,arguments)};function O(t,e,n,i){return new(n||(n=Promise))((function(r,o){function a(t){try{h(i.next(t))}catch(t){o(t)}}function s(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}h((i=i.apply(t,e||[])).next())}))}function R(t,e){var n,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function B(t){var e=t.map((function(t){return t[0]}));return e.push(t[t.length-1][1]),e}var _={lips:B(t),leftEye:B(e),leftEyebrow:B(n),leftIris:B(i),rightEye:B(r),rightEyebrow:B(o),rightIris:B(a),faceOval:B(s)},V=h,D=Object.entries(_).map((function(t){var e=t[0];return t[1].map((function(t){return[t,e]}))})).flat(),H=new Map(D);function K(t){for(var e={locationData:{relativeKeypoints:[]}},n=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER,a=0;a<t.length;++a){var s=t[a];n=Math.min(n,s.x),i=Math.max(i,s.x),r=Math.min(r,s.y),o=Math.max(o,s.y),e.locationData.relativeKeypoints.push({x:s.x,y:s.y})}return e.locationData.relativeBoundingBox={xMin:n,yMin:r,xMax:i,yMax:o,width:i-n,height:o-r},e}var U={runtime:"mediapipe",maxFaces:1,refineLandmarks:!1};var N=function(){function t(t){var e=this;this.width=0,this.height=0,this.selfieMode=!1,this.faceMeshSolution=new u({locateFile:function(e,n){return t.solutionPath?t.solutionPath.replace(/\/+$/,"")+"/"+e:n+"/"+e}}),this.faceMeshSolution.setOptions({refineLandmarks:t.refineLandmarks,selfieMode:this.selfieMode,maxNumFaces:t.maxFaces}),this.faceMeshSolution.onResults((function(t){if(e.height=t.image.height,e.width=t.image.width,e.faces=[],null!==t.multiFaceLandmarks)for(var n=t.multiFaceLandmarks,i=0;i<n.length;i++){var r=e.translateOutput(n[i]);e.faces.push({keypoints:r,box:K(r).locationData.relativeBoundingBox})}}))}return t.prototype.translateOutput=function(t){var e=this;return t.map((function(t,n){var i={x:t.x*e.width,y:t.y*e.height,z:t.z*e.width},r=H.get(n);return null!=r&&(i.name=r),i}))},t.prototype.estimateFaces=function(t,e){return O(this,void 0,void 0,(function(){var n,i;return R(this,(function(r){switch(r.label){case 0:return e&&e.flipHorizontal&&e.flipHorizontal!==this.selfieMode&&(this.selfieMode=e.flipHorizontal,this.faceMeshSolution.setOptions({selfieMode:this.selfieMode})),t instanceof c?(i=ImageData.bind,[4,l.toPixels(t)]):[3,2];case 1:return n=new(i.apply(ImageData,[void 0,r.sent(),t.shape[1],t.shape[0]])),[3,3];case 2:n=t,r.label=3;case 3:return t=n,[4,this.faceMeshSolution.send({image:t})];case 4:return r.sent(),[2,this.faces]}}))}))},t.prototype.dispose=function(){this.faceMeshSolution.close()},t.prototype.reset=function(){this.faceMeshSolution.reset(),this.width=0,this.height=0,this.faces=null,this.selfieMode=!1},t.prototype.initialize=function(){return this.faceMeshSolution.initialize()},t}();function P(t){return O(this,void 0,void 0,(function(){var e,n;return R(this,(function(i){switch(i.label){case 0:return e=function(t){if(null==t)return E({},U);var e=E({},t);return e.runtime="mediapipe",null==e.maxFaces&&(e.maxFaces=U.maxFaces),null==e.refineLandmarks&&(e.refineLandmarks=U.refineLandmarks),e}(t),[4,(n=new N(e)).initialize()];case 1:return i.sent(),[2,n]}}))}))}function j(t){return t.width*t.height}function W(t){var e=t.xCenter-t.width/2,n=e+t.width,i=t.yCenter-t.height/2;return{xMin:e,xMax:n,yMin:i,yMax:i+t.height,width:t.width,height:t.height}}function X(t,e){var n=W(t),i=W(e);if(!function(t,e){return!(t.xMax<e.xMin||e.xMax<t.xMin||t.yMax<e.yMin||e.yMax<t.yMin)}(n,i))return 0;var r=j(function(t,e){var n=Math.max(t.xMin,e.xMin),i=Math.min(t.xMax,e.xMax),r=Math.max(t.yMin,e.yMin),o=Math.min(t.yMax,e.yMax);return{xMin:n,xMax:i,yMin:r,yMax:o,width:Math.max(i-n,0),height:Math.max(o-r,0)}}(n,i)),o=j(n)+j(i)-r;return o>0?r/o:0}function Y(t,e,n,i){var r=t.width,o=t.height,a=i?-1:1,s=Math.cos(t.rotation),h=Math.sin(t.rotation),u=t.xCenter,c=t.yCenter,l=1/e,f=1/n,d=new Array(16);return d[0]=r*s*a*l,d[1]=-o*h*l,d[2]=0,d[3]=(-.5*r*s*a+.5*o*h+u)*l,d[4]=r*h*a*f,d[5]=o*s*f,d[6]=0,d[7]=(-.5*o*s-.5*r*h*a+c)*f,d[8]=0,d[9]=0,d[10]=r*l,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,function(t){if(16!==t.length)throw new Error("Array length must be 16 but got "+t.length);return[[t[0],t[1],t[2],t[3]],[t[4],t[5],t[6],t[7]],[t[8],t[9],t[10],t[11]],[t[12],t[13],t[14],t[15]]]}(d)}function q(t){return t instanceof c?{height:t.shape[0],width:t.shape[1]}:{height:t.height,width:t.width}}function G(t){return t-2*Math.PI*Math.floor((t+Math.PI)/(2*Math.PI))}function Z(t){return t instanceof c?t:l.fromPixels(t)}function $(t,e){f.assert(0!==t.width,(function(){return e+" width cannot be 0."})),f.assert(0!==t.height,(function(){return e+" height cannot be 0."}))}function J(t,e){var n=function(t,e,n,i){var r=e-t,o=i-n;if(0===r)throw new Error("Original min and max are both "+t+", range cannot be 0.");var a=o/r;return{scale:a,offset:n-t*a}}(0,255,e[0],e[1]);return d((function(){return p(m(t,n.scale),n.offset)}))}function Q(t,e,n){var i=e.outputTensorSize,r=e.keepAspectRatio,o=e.borderMode,a=e.outputTensorFloatRange,s=q(t),h=function(t,e){return e?{xCenter:e.xCenter*t.width,yCenter:e.yCenter*t.height,width:e.width*t.width,height:e.height*t.height,rotation:e.rotation}:{xCenter:.5*t.width,yCenter:.5*t.height,width:t.width,height:t.height,rotation:0}}(s,n),u=function(t,e,n){if(void 0===n&&(n=!1),!n)return{top:0,left:0,right:0,bottom:0};var i=e.height,r=e.width;$(e,"targetSize"),$(t,"roi");var o,a,s=i/r,h=t.height/t.width,u=0,c=0;return s>h?(o=t.width,a=t.width*s,c=(1-h/s)/2):(o=t.height/s,a=t.height,u=(1-s/h)/2),t.width=o,t.height=a,{top:c,left:u,right:u,bottom:c}}(h,i,r),c=Y(h,s.width,s.height,!1),l=d((function(){var e=Z(t),n=g(function(t,e,n){return $(n,"inputResolution"),[1/n.width*t[0][0]*e.width,1/n.height*t[0][1]*e.width,t[0][3]*e.width,1/n.width*t[1][0]*e.height,1/n.height*t[1][1]*e.height,t[1][3]*e.height,0,0]}(c,s,i),[1,8]),r="zero"===o?"constant":"nearest",h=x.transform(y(M(e,"float32")),n,"bilinear",r,0,[i.height,i.width]);return null!=a?J(h,a):h}));return{imageTensor:l,padding:u,transformationMatrix:c}}function tt(t){null==t.reduceBoxesInLowestLayer&&(t.reduceBoxesInLowestLayer=!1),null==t.interpolatedScaleAspectRatio&&(t.interpolatedScaleAspectRatio=1),null==t.fixedAnchorSize&&(t.fixedAnchorSize=!1);for(var e=[],n=0;n<t.numLayers;){for(var i=[],r=[],o=[],a=[],s=n;s<t.strides.length&&t.strides[s]===t.strides[n];){var h=et(t.minScale,t.maxScale,s,t.strides.length);if(0===s&&t.reduceBoxesInLowestLayer)o.push(1),o.push(2),o.push(.5),a.push(.1),a.push(h),a.push(h);else{for(var u=0;u<t.aspectRatios.length;++u)o.push(t.aspectRatios[u]),a.push(h);if(t.interpolatedScaleAspectRatio>0){var c=s===t.strides.length-1?1:et(t.minScale,t.maxScale,s+1,t.strides.length);a.push(Math.sqrt(h*c)),o.push(t.interpolatedScaleAspectRatio)}}s++}for(var l=0;l<o.length;++l){var f=Math.sqrt(o[l]);i.push(a[l]/f),r.push(a[l]*f)}var d=0,p=0;if(t.featureMapHeight.length>0)d=t.featureMapHeight[n],p=t.featureMapWidth[n];else{var m=t.strides[n];d=Math.ceil(t.inputSizeHeight/m),p=Math.ceil(t.inputSizeWidth/m)}for(var g=0;g<d;++g)for(var x=0;x<p;++x)for(var y=0;y<i.length;++y){var M={xCenter:(x+t.anchorOffsetX)/p,yCenter:(g+t.anchorOffsetY)/d,width:0,height:0};t.fixedAnchorSize?(M.width=1,M.height=1):(M.width=r[y],M.height=i[y]),e.push(M)}n=s}return e}function et(t,e,n,i){return 1===i?.5*(t+e):t+(e-t)*n/(i-1)}function nt(t,e){var n=e[0],i=e[1];return[n*t[0]+i*t[1]+t[3],n*t[4]+i*t[5]+t[7]]}function it(t){return{xCenter:t.xMin+t.width/2,yCenter:t.yMin+t.height/2,width:t.width,height:t.height}}function rt(t){var e=t.relativeKeypoints;if(e.length<=1)throw new Error("2 or more keypoints required to calculate a rect.");var n=Number.MAX_VALUE,i=Number.MAX_VALUE,r=Number.MIN_VALUE,o=Number.MIN_VALUE;return e.forEach((function(t){n=Math.min(n,t.x),r=Math.max(r,t.x),i=Math.min(i,t.y),o=Math.max(o,t.y)})),{xCenter:(n+r)/2,yCenter:(i+o)/2,width:r-n,height:o-i}}function ot(t,e,n,i,r){var o="rect"===n?function(t,e,n){var i,r=t.locationData;if("boundingbox"===e)i=it(r.boundingBox);else{i=rt(r);var o=n.width,a=n.height;i.xCenter=Math.round(i.xCenter*o),i.yCenter=Math.round(i.yCenter*a),i.width=Math.round(i.width*o),i.height=Math.round(i.height*a)}return i}(t,e,i):function(t,e){var n=t.locationData;return"boundingbox"===e?it(n.relativeBoundingBox):rt(n)}(t,e);return r&&(o.rotation=function(t,e,n){var i,r=t.locationData,o=n.rotationVectorStartKeypointIndex,a=n.rotationVectorEndKeypointIndex;i=n.rotationVectorTargetAngle?n.rotationVectorTargetAngle:Math.PI*n.rotationVectorTargetAngleDegree/180;var s=r.relativeKeypoints[o].x*e.width,h=r.relativeKeypoints[o].y*e.height,u=r.relativeKeypoints[a].x*e.width,c=r.relativeKeypoints[a].y*e.height;return G(i-Math.atan2(-(c-h),u-s))}(t,i,r)),o}function at(t){return d((function(){var e=function(t){return d((function(){return[v(t,[0,0,0],[1,-1,1]),v(t,[0,0,1],[1,-1,-1])]}))}(t),n=e[0],i=e[1];return{boxes:w(i),logits:w(n)}}))}function st(t,e,n){for(var i=0;i<e.length;++i){var r=e[i],o={x:r.x,y:r.y};n[t[i]]=o}}function ht(t,e,n,i){if("string"==typeof e){if("copy"===e)for(var r=0;r<n.length;++r)i[t[r]].z=n[r].z}else{var o=function(t,e){for(var n=0,i=0;i<e.length;++i)n+=t[e[i]].z;return n/e.length}(i,e);for(r=0;r<t.length;++r)i[t[r]].z=o}}function ut(t,e){for(var n=function(t){var e=[].concat.apply([],t.map((function(t){return t.indexesMapping})));if(0===e.length)throw new Error("There should be at least one landmark in indexes mapping");var n=e[0],i=e[0],r=new Set(e);r.forEach((function(t){n=Math.min(n,t),i=Math.max(i,t)}));var o=r.size;if(0!==n)throw new Error("Indexes are expected to start with 0 instead of "+n);if(i+1!==o)throw new Error("Indexes should have no gaps but "+(i-o+1)+" indexes are missing");return o}(e),i=new Array(n),r=0;r<t.length;++r){var o=t[r],a=e[r];if(o.length!==a.indexesMapping.length)throw new Error("There are "+o.length+" refinement landmarks while mapping has "+a.indexesMapping.length);st(a.indexesMapping,o,i),ht(a.indexesMapping,a.zRefinement,o,i)}return i}function ct(t,e,n,i){return O(this,void 0,void 0,(function(){var i,r,o,a,s;return R(this,(function(h){switch(h.label){case 0:return t.sort((function(t,e){return Math.max.apply(Math,e.score)-Math.max.apply(Math,t.score)})),i=g(t.map((function(t){return[t.locationData.relativeBoundingBox.yMin,t.locationData.relativeBoundingBox.xMin,t.locationData.relativeBoundingBox.yMax,t.locationData.relativeBoundingBox.xMax]}))),r=S(t.map((function(t){return t.score[0]}))),[4,x.nonMaxSuppressionAsync(i,r,e,n)];case 1:return[4,(o=h.sent()).array()];case 2:return a=h.sent(),s=t.filter((function(t,e){return a.indexOf(e)>-1})),b([i,r,o]),[2,s]}}))}))}function lt(t,e){return t.map((function(t){var n=E(E({},t),{x:t.x*e.width,y:t.y*e.height});return null!=t.z&&(n.z=t.z*e.width),n}))}function ft(t,e,n){return O(this,void 0,void 0,(function(){var i,r,o,a,s;return R(this,(function(h){switch(h.label){case 0:return i=t[0],r=t[1],o=function(t,e,n){return d((function(){var i,r,o,a;n.reverseOutputOrder?(r=w(v(t,[0,n.boxCoordOffset+0],[-1,1])),i=w(v(t,[0,n.boxCoordOffset+1],[-1,1])),a=w(v(t,[0,n.boxCoordOffset+2],[-1,1])),o=w(v(t,[0,n.boxCoordOffset+3],[-1,1]))):(i=w(v(t,[0,n.boxCoordOffset+0],[-1,1])),r=w(v(t,[0,n.boxCoordOffset+1],[-1,1])),o=w(v(t,[0,n.boxCoordOffset+2],[-1,1])),a=w(v(t,[0,n.boxCoordOffset+3],[-1,1]))),r=p(m(C(r,n.xScale),e.w),e.x),i=p(m(C(i,n.yScale),e.h),e.y),n.applyExponentialOnBoxSize?(o=m(T(C(o,n.hScale)),e.h),a=m(T(C(a,n.wScale)),e.w)):(o=m(C(o,n.hScale),e.h),a=m(C(a,n.wScale),e.h));var s=z(i,C(o,2)),h=z(r,C(a,2)),u=p(i,C(o,2)),c=p(r,C(a,2)),l=k([F(s,[n.numBoxes,1]),F(h,[n.numBoxes,1]),F(u,[n.numBoxes,1]),F(c,[n.numBoxes,1])],1);if(n.numKeypoints)for(var f=0;f<n.numKeypoints;++f){var d=n.keypointCoordOffset+f*n.numValuesPerKeypoint,g=void 0,x=void 0;n.reverseOutputOrder?(g=w(v(t,[0,d],[-1,1])),x=w(v(t,[0,d+1],[-1,1]))):(x=w(v(t,[0,d],[-1,1])),g=w(v(t,[0,d+1],[-1,1])));var y=p(m(C(g,n.xScale),e.w),e.x),M=p(m(C(x,n.yScale),e.h),e.y);l=k([l,F(y,[n.numBoxes,1]),F(M,[n.numBoxes,1])],1)}return l}))}(r,e,n),a=d((function(){var t=i;return n.sigmoidScore?(null!=n.scoreClippingThresh&&(t=L(i,-n.scoreClippingThresh,n.scoreClippingThresh)),t=I(t)):t})),[4,dt(o,a,n)];case 1:return s=h.sent(),b([o,a]),[2,s]}}))}))}function dt(t,e,n){return O(this,void 0,void 0,(function(){var i,r,o,a,s,h,u,c,l,f,d,p;return R(this,(function(m){switch(m.label){case 0:return i=[],[4,t.data()];case 1:return r=m.sent(),[4,e.data()];case 2:for(o=m.sent(),a=0;a<n.numBoxes;++a)if(!(null!=n.minScoreThresh&&o[a]<n.minScoreThresh||(s=a*n.numCoords,h=pt(r[s+0],r[s+1],r[s+2],r[s+3],o[a],n.flipVertically,a),(u=h.locationData.relativeBoundingBox).width<0||u.height<0))){if(n.numKeypoints>0)for((c=h.locationData).relativeKeypoints=[],l=n.numKeypoints*n.numValuesPerKeypoint,f=0;f<l;f+=n.numValuesPerKeypoint)d=s+n.keypointCoordOffset+f,p={x:r[d+0],y:n.flipVertically?1-r[d+1]:r[d+1]},c.relativeKeypoints.push(p);i.push(h)}return[2,i]}}))}))}function pt(t,e,n,i,r,o,a){return{score:[r],ind:a,locationData:{relativeBoundingBox:{xMin:e,yMin:o?1-n:t,xMax:i,yMax:o?1-t:n,width:i-e,height:n-t}}}}function mt(t,e){return"none"===t?e:function(t){return 1/(1+Math.exp(-t))}(e)}function gt(t,e,n,i){return O(this,void 0,void 0,(function(){var r,o,a,s,h,u,c,l;return R(this,(function(f){switch(f.label){case 0:return n=n||e.flipHorizontally||!1,i=i||e.flipVertically||!1,r=t.size,o=r/e.numLandmarks,[4,t.data()];case 1:for(a=f.sent(),s=[],h=0;h<e.numLandmarks;++h)u=h*o,(l={x:0,y:0}).x=n?e.inputImageWidth-a[u]:a[u],o>1&&(l.y=i?e.inputImageHeight-a[u+1]:a[u+1]),o>2&&(l.z=a[u+2]),o>3&&(l.score=mt(e.visibilityActivation,a[u+3])),s.push(l);for(c=0;c<s.length;++c)(l=s[c]).x=l.x/e.inputImageWidth,l.y=l.y/e.inputImageHeight,l.z=l.z/e.inputImageWidth/(e.normalizeZ||1);return[2,s]}}))}))}function xt(t,e,n){var i=t.width,r=t.height,o=t.rotation;if(null==n.rotation&&null==n.rotationDegree||(o=function(t,e){null!=e.rotation?t+=e.rotation:null!=e.rotationDegree&&(t+=Math.PI*e.rotationDegree/180);return G(t)}(o,n)),0===o)t.xCenter=t.xCenter+i*n.shiftX,t.yCenter=t.yCenter+r*n.shiftY;else{var a=(e.width*i*n.shiftX*Math.cos(o)-e.height*r*n.shiftY*Math.sin(o))/e.width,s=(e.width*i*n.shiftX*Math.sin(o)+e.height*r*n.shiftY*Math.cos(o))/e.height;t.xCenter=t.xCenter+a,t.yCenter=t.yCenter+s}if(n.squareLong){var h=Math.max(i*e.width,r*e.height);i=h/e.width,r=h/e.height}else if(n.squareShort){var u=Math.min(i*e.width,r*e.height);i=u/e.width,r=u/e.height}return t.width=i*n.scaleX,t.height=r*n.scaleY,t}var yt="https://storage.googleapis.com/tfjs-testing/face-detection/face_detection_short_range/model.json",Mt="https://storage.googleapis.com/tfjs-testing/face-detection/face_landmark/model.json",vt={reduceBoxesInLowestLayer:!1,interpolatedScaleAspectRatio:1,featureMapHeight:[],featureMapWidth:[],numLayers:4,minScale:.1484375,maxScale:.75,inputSizeHeight:128,inputSizeWidth:128,anchorOffsetX:.5,anchorOffsetY:.5,strides:[8,16,16,16],aspectRatios:[1],fixedAnchorSize:!0},wt={reduceBoxesInLowestLayer:!1,interpolatedScaleAspectRatio:0,featureMapHeight:[],featureMapWidth:[],numLayers:1,minScale:.1484375,maxScale:.75,inputSizeHeight:192,inputSizeWidth:192,anchorOffsetX:.5,anchorOffsetY:.5,strides:[4],aspectRatios:[1],fixedAnchorSize:!0},bt={modelType:"short",maxFaces:1,detectorModelUrl:yt},St={runtime:"tfjs",maxFaces:1,refineLandmarks:!1,detectorModelUrl:yt,landmarkModelUrl:Mt},Ct={flipHorizontal:!1,staticImageMode:!1},Tt={applyExponentialOnBoxSize:!1,flipVertically:!1,ignoreClasses:[],numClasses:1,numBoxes:896,numCoords:16,boxCoordOffset:0,keypointCoordOffset:4,numKeypoints:6,numValuesPerKeypoint:2,sigmoidScore:!0,scoreClippingThresh:100,reverseOutputOrder:!0,xScale:128,yScale:128,hScale:128,wScale:128,minScoreThresh:.5},zt={applyExponentialOnBoxSize:!1,flipVertically:!1,ignoreClasses:[],numClasses:1,numBoxes:2304,numCoords:16,boxCoordOffset:0,keypointCoordOffset:4,numKeypoints:6,numValuesPerKeypoint:2,sigmoidScore:!0,scoreClippingThresh:100,reverseOutputOrder:!0,xScale:192,yScale:192,hScale:192,wScale:192,minScoreThresh:.6},kt=.3,Ft={shiftX:0,shiftY:0,scaleX:1.5,scaleY:1.5,squareLong:!0},Lt={outputTensorSize:{width:128,height:128},keepAspectRatio:!0,outputTensorFloatRange:[-1,1],borderMode:"zero"},It={outputTensorSize:{width:192,height:192},keepAspectRatio:!0,outputTensorFloatRange:[-1,1],borderMode:"zero"},At={outputTensorSize:{width:192,height:192},outputTensorFloatRange:[0,1],borderMode:"replicate"},Et={numLandmarks:468,inputImageWidth:192,inputImageHeight:192,visibilityActivation:"none",flipHorizontally:!1,flipVertically:!1},Ot={numLandmarks:80,inputImageWidth:192,inputImageHeight:192,visibilityActivation:"none",flipHorizontally:!1,flipVertically:!1},Rt={numLandmarks:71,inputImageWidth:192,inputImageHeight:192,visibilityActivation:"none",flipHorizontally:!1,flipVertically:!1},Bt={numLandmarks:5,inputImageWidth:192,inputImageHeight:192,visibilityActivation:"none",flipHorizontally:!1,flipVertically:!1},_t={indexesMapping:Array.from(Array(468).keys()),zRefinement:"copy"},Vt={indexesMapping:[61,146,91,181,84,17,314,405,321,375,291,185,40,39,37,0,267,269,270,409,78,95,88,178,87,14,317,402,318,324,308,191,80,81,82,13,312,311,310,415,76,77,90,180,85,16,315,404,320,307,306,184,74,73,72,11,302,303,304,408,62,96,89,179,86,15,316,403,319,325,292,183,42,41,38,12,268,271,272,407],zRefinement:"none"},Dt={indexesMapping:[33,7,163,144,145,153,154,155,133,246,161,160,159,158,157,173,130,25,110,24,23,22,26,112,243,247,30,29,27,28,56,190,226,31,228,229,230,231,232,233,244,113,225,224,223,222,221,189,35,124,46,53,52,65,143,111,117,118,119,120,121,128,245,156,70,63,105,66,107,55,193],zRefinement:"none"},Ht={indexesMapping:[263,249,390,373,374,380,381,382,362,466,388,387,386,385,384,398,359,255,339,254,253,252,256,341,463,467,260,259,257,258,286,414,446,261,448,449,450,451,452,453,464,342,445,444,443,442,441,413,265,353,276,283,282,295,372,340,346,347,348,349,350,357,465,383,300,293,334,296,336,285,417],zRefinement:"none"},Kt={indexesMapping:[468,469,470,471,472],zRefinement:[33,7,163,144,145,153,154,155,133,246,161,160,159,158,157,173]},Ut={indexesMapping:[473,474,475,476,477],zRefinement:[263,249,390,373,374,380,381,382,362,466,388,387,386,385,384,398]};var Nt=function(){function t(t,e,n){this.detectorModel=e,this.maxFaces=n,"full"===t?(this.imageToTensorConfig=It,this.tensorsToDetectionConfig=zt,this.anchors=tt(wt)):(this.imageToTensorConfig=Lt,this.tensorsToDetectionConfig=Tt,this.anchors=tt(vt));var i=S(this.anchors.map((function(t){return t.width}))),r=S(this.anchors.map((function(t){return t.height}))),o=S(this.anchors.map((function(t){return t.xCenter}))),a=S(this.anchors.map((function(t){return t.yCenter})));this.anchorTensor={x:o,y:a,w:i,h:r}}return t.prototype.dispose=function(){this.detectorModel.dispose(),b([this.anchorTensor.x,this.anchorTensor.y,this.anchorTensor.w,this.anchorTensor.h])},t.prototype.reset=function(){},t.prototype.detectFaces=function(t,e){return void 0===e&&(e=!1),O(this,void 0,void 0,(function(){var n,i,r,o,a,s,h,u,c,l,f;return R(this,(function(p){switch(p.label){case 0:return null==t?(this.reset(),[2,[]]):(n=d((function(){var n=M(Z(t),"float32");if(e){n=w(x.flipLeftRight(y(n,0)),[0])}return n})),i=Q(n,this.imageToTensorConfig),r=i.imageTensor,o=i.transformationMatrix,a=this.detectorModel.execute(r,"Identity:0"),s=at(a),h=s.boxes,[4,ft([u=s.logits,h],this.anchorTensor,this.tensorsToDetectionConfig)]);case 1:return 0===(c=p.sent()).length?(b([n,r,a,u,h]),[2,c]):[4,ct(c,this.maxFaces,kt)];case 2:return l=p.sent(),f=function(t,e){void 0===t&&(t=[]);var n,i=(n=e,[].concat.apply([],n));return t.forEach((function(t){var e=t.locationData;e.relativeKeypoints.forEach((function(t){var e=nt(i,[t.x,t.y]),n=e[0],r=e[1];t.x=n,t.y=r}));var n=e.relativeBoundingBox,r=Number.MAX_VALUE,o=Number.MAX_VALUE,a=Number.MIN_VALUE,s=Number.MIN_VALUE;[[n.xMin,n.yMin],[n.xMin+n.width,n.yMin],[n.xMin+n.width,n.yMin+n.height],[n.xMin,n.yMin+n.height]].forEach((function(t){var e=nt(i,t),n=e[0],h=e[1];r=Math.min(r,n),a=Math.max(a,n),o=Math.min(o,h),s=Math.max(s,h)})),e.relativeBoundingBox={xMin:r,xMax:a,yMin:o,yMax:s,width:a-r,height:s-o}})),t}(l,o),b([n,r,a,u,h]),[2,f]}}))}))},t}();function Pt(t){return O(this,void 0,void 0,(function(){var e,n,i;return R(this,(function(r){switch(r.label){case 0:return e=function(t){if(null==t)return E({},bt);var e=E({},t);null==e.modelType&&(e.modelType=bt.modelType),null==e.maxFaces&&(e.maxFaces=bt.maxFaces),null==e.detectorModelUrl&&("full"===e.modelType?e.detectorModelUrl="https://storage.googleapis.com/tfjs-testing/face-detection/face_detection_full_range_sparse/model.json":e.detectorModelUrl=yt);return e}(t),n="string"==typeof e.detectorModelUrl&&e.detectorModelUrl.indexOf("https://tfhub.dev")>-1,[4,A(e.detectorModelUrl,{fromTFHub:n})];case 1:return i=r.sent(),[2,new Nt(e.modelType,i,e.maxFaces)]}}))}))}var jt,Wt=function(){function t(t,e,n,i){this.detector=t,this.landmarkModel=e,this.maxFaces=n,this.withAttention=i,this.prevFaceRectsFromLandmarks=null}return t.prototype.estimateFaces=function(t,e){return O(this,void 0,void 0,(function(){var n,i,r,o,a,s,h,u,c,l,f,p,m,g=this;return R(this,(function(v){switch(v.label){case 0:return n=function(t){if(null==t)return E({},Ct);var e=E({},t);return null==e.flipHorizontal&&(e.flipHorizontal=Ct.flipHorizontal),null==e.staticImageMode&&(e.staticImageMode=Ct.staticImageMode),e}(e),null==t?(this.reset(),[2,[]]):(i=q(t),r=d((function(){var e=M(Z(t),"float32");if(n.flipHorizontal){e=w(x.flipLeftRight(y(e,0)),[0])}return e})),o=this.prevFaceRectsFromLandmarks,n.staticImageMode||null==o||o.length<this.maxFaces?[4,this.detector.detectFaces(r)]:[3,2]);case 1:return 0===(s=v.sent()).length?(this.reset(),r.dispose(),[2,[]]):(a=s.map((function(t){return g.faceDetectionFrontDetectionToRoi(t,i)})),[3,3]);case 2:a=[],v.label=3;case 3:return b=.5,S=[],[a,o||[]].forEach((function(t){return t.forEach((function(t){(S=S.filter((function(e){return X(t,e)<=b}))).push(t)}))})),h=S,[4,Promise.all(h.map((function(t){return g.faceLandmark(t,r)})))];case 4:for(u=v.sent(),c=[],this.prevFaceRectsFromLandmarks=[],l=0;l<u.length;++l)null!=(f=u[l])&&(this.prevFaceRectsFromLandmarks.push(this.faceLandmarksToRoi(f,i)),null!=(p=lt(f,i))&&p.forEach((function(t,e){var n=H.get(e);null!=n&&(t.name=n)})),m=K(p),c.push({keypoints:p,box:m.locationData.relativeBoundingBox}));return r.dispose(),[2,c]}var b,S}))}))},t.prototype.dispose=function(){this.detector.dispose(),this.landmarkModel.dispose()},t.prototype.reset=function(){this.detector.reset(),this.prevFaceRectsFromLandmarks=null},t.prototype.faceDetectionFrontDetectionToRoi=function(t,e){return xt(ot(t,"boundingbox","normRect",e,{rotationVectorStartKeypointIndex:0,rotationVectorEndKeypointIndex:1,rotationVectorTargetAngleDegree:0}),e,Ft)},t.prototype.faceLandmark=function(t,e){return O(this,void 0,void 0,(function(){var n,i,r,o,a,s,h;return R(this,(function(u){switch(u.label){case 0:return n=Q(e,At,t).imageTensor,i=["output_faceflag"].concat(this.withAttention?["output_mesh_identity","output_lips","Identity_6:0","Identity_1:0","Identity_2:0","Identity_5:0"]:["output_mesh"]),r=this.landmarkModel.execute(n,i),o=r[0],a=r.slice(1),[4,o.data()];case 1:return u.sent()[0]<.5?(b(r),b(n),[2,null]):this.withAttention?[4,this.tensorsToFaceLandmarksWithAttention(a)]:[3,3];case 2:return s=u.sent(),[3,5];case 3:return[4,this.tensorsToFaceLandmarks(a)];case 4:s=u.sent(),u.label=5;case 5:return h=function(t,e,n){void 0===n&&(n={ignoreRotation:!1});for(var i=[],r=0,o=t;r<o.length;r++){var a=o[r],s=a.x-.5,h=a.y-.5,u=n.ignoreRotation?0:e.rotation,c=Math.cos(u)*s-Math.sin(u)*h,l=Math.sin(u)*s+Math.cos(u)*h;c=c*e.width+e.xCenter,l=l*e.height+e.yCenter;var f=a.z*e.width,d=E({},a);d.x=c,d.y=l,d.z=f,i.push(d)}return i}(s,t),b(r),b(n),[2,h]}}))}))},t.prototype.tensorsToFaceLandmarks=function(t){return O(this,void 0,void 0,(function(){return R(this,(function(e){return[2,gt(t[0],Et)]}))}))},t.prototype.tensorsToFaceLandmarksWithAttention=function(t){return O(this,void 0,void 0,(function(){var e,n,i,r,o,a;return R(this,(function(s){switch(s.label){case 0:return[4,gt(t[0],Et)];case 1:return e=s.sent(),[4,gt(t[1],Ot)];case 2:return n=s.sent(),[4,gt(t[3],Rt)];case 3:return i=s.sent(),[4,gt(t[5],Rt)];case 4:return r=s.sent(),[4,gt(t[4],Bt)];case 5:return o=s.sent(),[4,gt(t[2],Bt)];case 6:return a=s.sent(),[2,ut([e,n,i,r,o,a],[_t,Vt,Dt,Ht,Kt,Ut])]}}))}))},t.prototype.faceLandmarksToRoi=function(t,e){return xt(ot(K(t),"boundingbox","normRect",e,{rotationVectorStartKeypointIndex:33,rotationVectorEndKeypointIndex:263,rotationVectorTargetAngleDegree:0}),e,Ft)},t}();function Xt(t){return O(this,void 0,void 0,(function(){var e,n,i,r;return R(this,(function(o){switch(o.label){case 0:return e=function(t){if(null==t)return E({},St);var e=E({},t);return e.runtime="tfjs",null==e.maxFaces&&(e.maxFaces=St.maxFaces),null==e.refineLandmarks&&(e.refineLandmarks=St.refineLandmarks),null==e.detectorModelUrl&&(e.detectorModelUrl=yt),null==e.landmarkModelUrl&&(e.landmarkModelUrl=e.refineLandmarks?"https://storage.googleapis.com/tfjs-testing/face-detection/face_landmark_with_attention/model.json":Mt),e}(t),n="string"==typeof e.landmarkModelUrl&&e.landmarkModelUrl.indexOf("https://tfhub.dev")>-1,[4,A(e.landmarkModelUrl,{fromTFHub:n})];case 1:return i=o.sent(),[4,Pt({modelType:"short",maxFaces:e.maxFaces,detectorModelUrl:e.detectorModelUrl})];case 2:return r=o.sent(),[2,new Wt(r,i,e.maxFaces,e.refineLandmarks)]}}))}))}function Yt(t,e){return O(this,void 0,void 0,(function(){var n,i;return R(this,(function(r){if(t===jt.MediaPipeFaceMesh){if(i=void 0,null!=(n=e)){if("tfjs"===n.runtime)return[2,Xt(n)];if("mediapipe"===n.runtime)return[2,P(n)];i=n.runtime}throw new Error("Expect modelConfig.runtime to be either 'tfjs' or 'mediapipe', but got "+i)}throw new Error(t+" is not a supported model name.")}))}))}!function(t){t.MediaPipeFaceMesh="MediaPipeFaceMesh"}(jt||(jt={}));var qt=Object.freeze({__proto__:null,getKeypointIndexByContour:function(t){if(t===jt.MediaPipeFaceMesh)return _;throw new Error("Model "+t+" is not supported.")},getAdjacentPairs:function(t){if(t===jt.MediaPipeFaceMesh)return V;throw new Error("Model "+t+" is not supported.")}});export{jt as SupportedModels,Yt as createDetector,qt as util};
